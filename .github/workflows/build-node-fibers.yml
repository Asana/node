name: Build node-fibers with prebuilt Node

on:
  workflow_dispatch:
  workflow_run:
    workflows: [Build Node]
    types:
      - completed
  pull_request:
    paths: .github/workflows/build-node-fibers.yml
  push:
    branches:
      - v20.18.3
      - workflows-for-v20.18.3

jobs:
  build-fibers:
    strategy:
      matrix:
        include:
          - platform: linux
            arch: x64
            runs_on: ubuntu-latest
          - platform: linux
            arch: arm64
            runs_on: ubuntu-24.04-arm
    runs-on: ${{ matrix.runs_on }}

    env:
      NODE_VERSION: v20.18.3

    steps:
      - name: Debug Matrix Values
        run: |
          echo "Matrix platform: ${{ matrix.platform }}"
          echo "Matrix arch: ${{ matrix.arch }}"

      - name: Download Node archive
        run: |
          gh release download node-${{ env.NODE_VERSION }}-release \
            --repo asana/node \
            --pattern "node-${{ env.NODE_VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-LATEST.tar.xz"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Node archive
        run: |
          mkdir -p node-install
          tar -C node-install -xJf node-${{ env.NODE_VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-LATEST.tar.xz
          echo "$GITHUB_WORKSPACE/node-install/usr/local/bin" >> $GITHUB_PATH

      - name: Verify Node Binary Architecture
        run: |
          echo "Node File:"
          file $GITHUB_WORKSPACE/node-install/usr/local/bin/node
          echo "Runner architecture:"
          uname -m

      - name: Checkout node-fibers fork
        uses: actions/checkout@v3
        with:
          repository: asana/node-fibers
          ref: jackstrohm_node20_fibers
          path: node-fibers

      - name: Build node-fibers
        working-directory: node-fibers
        run: |
          which node
          node -v
          node -p "process.arch"
          npm install --nodedir="$GITHUB_WORKSPACE/node-install/usr/local"
          npm test || true
          rm bin/repl
          find .


      - name: Upload fibers.node archive latest
        uses: actions/upload-artifact@v4
        with:
          name: node-fibers-${{ env.NODE_VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-LATEST
          path: node-fibers/bin/*

      - name: Upload fibers.node archive to release
        uses: softprops/action-gh-release@v1
        with:
          name: node-fibers-${{ env.NODE_VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-LATEST
          tag_name: node-fibers-${{ env.NODE_VERSION }}-release
          files: ./node-fibers/bin/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

